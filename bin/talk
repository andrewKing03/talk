#!/usr/bin/env ruby

basepath = File.expand_path(File.dirname(__FILE__) + '/..')
lib = File.join(basepath, 'lib')
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'talk'
require 'pp'
require 'json'

$parser = Talk::Parser.new

def process_file(file)
	unless File.readable?(file) then
		$stderr.write "talk: #{file}: No such file or directory\n"
		return
	end

	if File.directory?(file) then
		Dir.glob(File.join(file, "/**/*.talk")).each do |subfile|
			process_file(subfile)
		end
	else
		$parser.parse_file(file)
	end
end

begin
	ARGV.each do |file|
		process_file(file)
	end

	puts JSON.generate($parser.results)
rescue Talk::ParseError => e
	puts e
	exit 1
end
